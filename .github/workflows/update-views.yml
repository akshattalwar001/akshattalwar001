name: Update Profile Views

on:
  schedule:
    - cron: "*/10 * * * *"  # Every 10 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  update-views:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fetch current views
        id: fetch
        run: |
          GIST_ID="c3652432c09553c98eca4e6771f6e145"
          RESPONSE=$(curl -s "https://gist.githubusercontent.com/akshattalwar001/${GIST_ID}/raw/profile-views.json")
          echo "Current data: $RESPONSE"
          
          # Extract views count
          VIEWS=$(echo "$RESPONSE" | jq -r '.views')
          echo "Current views: $VIEWS"
          
          # Increment
          NEW_VIEWS=$((VIEWS + 1))
          echo "New views: $NEW_VIEWS"
          echo "views=$NEW_VIEWS" >> $GITHUB_OUTPUT

      - name: Update Gist
        run: |
          GIST_ID="c3652432c09553c98eca4e6771f6e145"
          NEW_VIEWS="${{ steps.fetch.outputs.views }}"
          
          # Create JSON payload
          JSON_PAYLOAD=$(jq -n \
            --arg views "$NEW_VIEWS" \
            '{
              "files": {
                "profile-views.json": {
                  "content": "{\"views\": \($views)}"
                }
              }
            }')
          
          echo "Updating Gist with: $JSON_PAYLOAD"
          
          # Update the Gist
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/gists/${GIST_ID}" \
            -d "$JSON_PAYLOAD"
          
          echo "âœ… Profile views updated to: $NEW_VIEWS"
