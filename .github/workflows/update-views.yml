name: Update Profile Views

on:
  schedule:
    - cron: "*/10 * * * *"  # Every 10 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  update-views:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fetch and Update Views
        run: |
          GIST_ID="c3652432c09553c98eca4e6771f6e145"
          
          # Fetch current data
          RESPONSE=$(curl -s "https://gist.githubusercontent.com/akshattalwar001/${GIST_ID}/raw/profile-views.json")
          echo "Current data: $RESPONSE"
          
          # Extract current count (handles both old and new format)
          if echo "$RESPONSE" | jq -e '.message' > /dev/null 2>&1; then
            # New shields.io format
            CURRENT_VIEWS=$(echo "$RESPONSE" | jq -r '.message')
          else
            # Old simple format
            CURRENT_VIEWS=$(echo "$RESPONSE" | jq -r '.views // 4570')
          fi
          
          echo "Current views: $CURRENT_VIEWS"
          
          # Increment
          NEW_VIEWS=$((CURRENT_VIEWS + 1))
          echo "New views: $NEW_VIEWS"
          
          # Create shields.io compatible JSON
          SHIELDS_JSON=$(jq -n \
            --arg count "$NEW_VIEWS" \
            '{
              "schemaVersion": 1,
              "label": "Profile Views",
              "message": $count,
              "color": "blue"
            }')
          
          echo "New JSON: $SHIELDS_JSON"
          
          # Create Gist update payload
          GIST_PAYLOAD=$(jq -n \
            --arg content "$SHIELDS_JSON" \
            '{
              "files": {
                "profile-views.json": {
                  "content": $content
                }
              }
            }')
          
          # Update the Gist
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/gists/${GIST_ID}" \
            -d "$GIST_PAYLOAD"
          
          echo "âœ… Profile views updated to: $NEW_VIEWS"
          
          # Force badge cache refresh by pinging shields.io
          sleep 2
          curl -s "https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/akshattalwar001/c3652432c09553c98eca4e6771f6e145/raw/profile-views.json" > /dev/null
          echo "ğŸ”„ Badge cache refreshed"
